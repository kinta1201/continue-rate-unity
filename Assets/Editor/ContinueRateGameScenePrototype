using UnityEngine;
using UnityEngine.UI;

/// <summary>
/// Gameã‚·ãƒ¼ãƒ³ã ã‘ã§ã€Œç¶™ç¶šç‡ä½“æ„Ÿ / å½“ã¦ã€ã‚’ä½“é¨“ã§ãã‚‹ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—
/// - ä½“æ„Ÿãƒ¢ãƒ¼ãƒ‰: ç¶™ç¶šç‡ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¨­å®š
/// - å½“ã¦ãƒ¢ãƒ¼ãƒ‰: 1ã€œ100%ã‚’å†…éƒ¨ã§ãƒ©ãƒ³ãƒ€ãƒ è¨­å®šï¼ˆç”»é¢ã«ã¯éè¡¨ç¤ºï¼‰
/// - ãƒ‰ã‚¢ã‚’æŠ¼ã™â†’æˆåŠŸ/å¤±æ•—â†’æˆåŠŸãªã‚‰æ¬¡ã¸ã€å¤±æ•—ãªã‚‰ãƒ‰ãƒœãƒ³ï¼†é€£ç¶šæ•°è¡¨ç¤º
/// </summary>
public class ContinueRateGameScenePrototype : MonoBehaviour
{
    public enum Mode
    {
        Experience = 0,
        Guess = 1
    }

    [Header("UI (AutoBuildç”Ÿæˆç‰©ã‚’Findã—ã¦è‡ªå‹•æ¥ç¶š)")]
    [SerializeField] private Dropdown modeDropdown;
    [SerializeField] private Slider rateSlider;
    [SerializeField] private Text rateLabel;
    [SerializeField] private Button doorButton;
    [SerializeField] private Text doorLabel;
    [SerializeField] private Text infoText;
    [SerializeField] private Button nextOrRetryButton;
    [SerializeField] private Text nextOrRetryLabel;

    private Mode mode = Mode.Experience;

    private int actualRate;       // ä»Šã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®çœŸã®ç¶™ç¶šç‡(1-100)
    private int streak = 0;       // é€£ç¶šæˆåŠŸ
    private int bestStreak = 0;   // æœ€é«˜é€£ç¶š
    private bool waitingNext = false;

    private void Awake()
    {
        // AutoBuildã§ç”Ÿæˆã—ãŸåå‰ã‹ã‚‰æ‹¾ã†ï¼ˆæ‰‹å‹•å‚ç…§ã‚¼ãƒ­ï¼‰
        modeDropdown = modeDropdown ?? GameObject.Find("ModeDropdown")?.GetComponent<Dropdown>();
        rateSlider = rateSlider ?? GameObject.Find("RateSlider")?.GetComponent<Slider>();
        rateLabel = rateLabel ?? GameObject.Find("RateLabel")?.GetComponent<Text>();
        doorButton = doorButton ?? GameObject.Find("DoorButton")?.GetComponent<Button>();
        doorLabel = doorLabel ?? GameObject.Find("DoorLabel")?.GetComponent<Text>();
        infoText = infoText ?? GameObject.Find("InfoText")?.GetComponent<Text>();
        nextOrRetryButton = nextOrRetryButton ?? GameObject.Find("NextOrRetryButton")?.GetComponent<Button>();
        nextOrRetryLabel = nextOrRetryLabel ?? GameObject.Find("NextOrRetryLabel")?.GetComponent<Text>();
    }

    private void Start()
    {
        // UIåˆæœŸåŒ–
        if (modeDropdown != null)
        {
            modeDropdown.ClearOptions();
            modeDropdown.AddOptions(new System.Collections.Generic.List<string>
            {
                "ç¶™ç¶šç‡ä½“æ„Ÿãƒ¢ãƒ¼ãƒ‰",
                "ç¶™ç¶šç‡å½“ã¦ãƒ¢ãƒ¼ãƒ‰"
            });
            modeDropdown.onValueChanged.AddListener(OnModeChanged);
            modeDropdown.value = 0;
        }

        if (rateSlider != null)
        {
            rateSlider.minValue = 1;
            rateSlider.maxValue = 100;
            rateSlider.wholeNumbers = true;
            rateSlider.value = 80; // ãƒ‡ãƒ•ã‚©ã§80%
            rateSlider.onValueChanged.AddListener(_ => RefreshRateLabel());
        }

        if (doorButton != null)
        {
            doorButton.onClick.RemoveAllListeners();
            doorButton.onClick.AddListener(OnDoorPressed);
        }

        if (nextOrRetryButton != null)
        {
            nextOrRetryButton.onClick.RemoveAllListeners();
            nextOrRetryButton.onClick.AddListener(OnNextOrRetry);
        }

        ApplyModeUI();
        BeginNewStage();
        Render();
    }

    private void OnModeChanged(int v)
    {
        mode = (v == 0) ? Mode.Experience : Mode.Guess;
        ApplyModeUI();

        // ãƒ¢ãƒ¼ãƒ‰å¤‰ãˆãŸã‚‰ãƒªã‚»ãƒƒãƒˆã—ã¦å³ä½“é¨“ã§ãã‚‹ã‚ˆã†ã«
        streak = 0;
        waitingNext = false;
        BeginNewStage();
        Render();
    }

    private void ApplyModeUI()
    {
        // ä½“æ„Ÿãƒ¢ãƒ¼ãƒ‰ã¯ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºã€å½“ã¦ãƒ¢ãƒ¼ãƒ‰ã¯éš ã™
        if (rateSlider != null) rateSlider.gameObject.SetActive(mode == Mode.Experience);
        if (rateLabel != null)  rateLabel.gameObject.SetActive(mode == Mode.Experience);
        RefreshRateLabel();
    }

    private void RefreshRateLabel()
    {
        if (rateLabel == null || rateSlider == null) return;
        rateLabel.text = $"è¨­å®šç¶™ç¶šç‡ï¼š{(int)rateSlider.value}%";
    }

    private void BeginNewStage()
    {
        if (mode == Mode.Experience)
        {
            actualRate = Mathf.Clamp((int)rateSlider.value, 1, 100);
        }
        else
        {
            actualRate = Random.Range(1, 101); // 1ã€œ100
        }
    }

    private void OnDoorPressed()
    {
        if (waitingNext) return; // çµæœå¾…ã¡ä¸­ã¯ç„¡è¦–

        // æŠ½é¸
        int roll = Random.Range(0, 100); // 0ã€œ99
        bool success = roll < actualRate;

        if (success)
        {
            streak++;
            bestStreak = Mathf.Max(bestStreak, streak);
            waitingNext = true;

            if (infoText != null)
            {
                string rateShown = (mode == Mode.Experience) ? $"{actualRate}%" : "ï¼Ÿï¼Ÿ%";
                infoText.text =
                    $"âœ… æ­£è§£ï¼ ç¶™ç¶šã—ãŸï¼\n" +
                    $"ï¼ˆæŠ½é¸ï¼š{roll} / ç¶™ç¶šç‡ï¼š{rateShown}ï¼‰\n\n" +
                    $"é€£ç¶šï¼š{streak}  / æœ€é«˜ï¼š{bestStreak}";
            }

            if (nextOrRetryLabel != null) nextOrRetryLabel.text = "æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸";
        }
        else
        {
            // ãƒ‰ãƒœãƒ³
            int lastStreak = streak;
            streak = 0;
            waitingNext = true;

            if (infoText != null)
            {
                string rateShown = (mode == Mode.Experience) ? $"{actualRate}%" : "ï¼Ÿï¼Ÿ%";
                infoText.text =
                    $"ğŸ’¥ ãƒ‰ãƒœãƒ³ï¼ å¤±æ•—â€¦\n" +
                    $"ï¼ˆæŠ½é¸ï¼š{roll} / ç¶™ç¶šç‡ï¼š{rateShown}ï¼‰\n\n" +
                    $"ä»Šå›ã®é€£ç¶šï¼š{lastStreak}  / æœ€é«˜ï¼š{bestStreak}";
            }

            if (nextOrRetryLabel != null) nextOrRetryLabel.text = "ã‚‚ã†ä¸€å›";
        }

        Render();
    }

    private void OnNextOrRetry()
    {
        if (!waitingNext) return;

        waitingNext = false;
        BeginNewStage();
        Render();
    }

    private void Render()
    {
        // Doorè¡¨ç¤º
        if (doorLabel != null)
        {
            doorLabel.text = waitingNext ? "OK" : "Door";
        }

        // ãƒœã‚¿ãƒ³çŠ¶æ…‹
        if (doorButton != null) doorButton.interactable = !waitingNext;
        if (nextOrRetryButton != null) nextOrRetryButton.interactable = waitingNext;

        // åˆæœŸèª¬æ˜
        if (infoText != null && !waitingNext)
        {
            if (mode == Mode.Experience)
            {
                infoText.text =
                    "ãƒ‰ã‚¢ã‚’æŠ¼ã—ã¦ç¶™ç¶šã§ãã‚‹ã‹ä½“æ„Ÿã—ã‚ˆã†ã€‚\n" +
                    "æˆåŠŸâ†’æ¬¡ã¸ / å¤±æ•—â†’ãƒ‰ãƒœãƒ³ï¼ˆé€£ç¶šæ•°è¡¨ç¤ºï¼‰\n\n" +
                    $"é€£ç¶šï¼š{streak} / æœ€é«˜ï¼š{bestStreak}";
            }
            else
            {
                infoText.text =
                    "ç¶™ç¶šç‡ã¯éå…¬é–‹ï¼ˆ1ã€œ100%ã§å†…éƒ¨è¨­å®šï¼‰ã€‚\n" +
                    "ãƒ‰ã‚¢ã‚’æŠ¼ã—ã¦ä½“æ„Ÿã§å½“ã¦ã‚ˆã†ã€‚\n\n" +
                    $"é€£ç¶šï¼š{streak} / æœ€é«˜ï¼š{bestStreak}";
            }
        }
    }
}
